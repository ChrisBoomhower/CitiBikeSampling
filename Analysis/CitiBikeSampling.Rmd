---
title: "MSDS 6370 Sampling Design"
output:
  html_notebook: default
---

### Load the data

Load necessary libraries

```{r}
require(survey)
```

Pulling in data only if RDS file has not already been created.

```{r}
##setwd("C:\\Users\\Owner\\Documents\\GitHub\\MSDS_6370\\CitiBikeSampling\\Analysis\\Data")
setwd("D:\\Documents\\School\\SMU\\2017 Summer\\MSDS6370 - Statistical Sampling\\Project\\CitiBikeSampling\\Analysis\\Data")
if(!file.exists("popData.rds")){
    pop.data <- NULL
    for(i in 1:length(list.files())){
        data.frag <- read.csv(paste("dataset",i,".csv",sep = ""), header = FALSE)
        pop.data <- rbind(pop.data, data.frag)
    }
    colnames(pop.data) <- c("tripduration",
                            "starttime",
                            "stoptime",
                            "start_station_id",
                            "start_station_name",
                            "start_station_latitude",
                            "start_station_longitude",
                            "end_station_id",
                            "end_station_name",
                            "end_station_latitude",
                            "end_station_longitude",
                            "bikeid",
                            "usertype",
                            "birth year",
                            "gender",
                            "LinearDistance",
                            "DayOfWeek",
                            "TimeOfDay",
                            "HolidayFlag",
                            "PRCP",
                            "SNOW",
                            "TAVE",
                            "TMAX",
                            "TMIN")
    saveRDS(pop.data, "popData.rds")
    rm(data.frag)
} else pop.data <- readRDS("popData.rds")
```
```{r}
boxplot(tripduration ~ DayOfWeek, data = pop.data, ylab = "tripduration", xlab = "DayOfWeek")
```

### Task 1
#### Stratified Sampling (Proportional Allocation)

First, we estimate the number of samples needed for a simple random sample(SRS) design. Although our goal is to perform a stratified sample for our estimate, we first need to compute a SRS design estimate to assist in calculation of design effect for the stratified design.

Step 1: $n_{0,srs}=\frac{(Z_{\alpha/2}S)^2}{(moe)^2}=\frac{1.96^2 \times 3996.942^2}{(15)^2}=272762.95\approx272763$

Step 2: $n_{srs}=\frac{n_{0,srs}}{1+\frac{n_{0,srs}}{N}}=\frac{272763}{1+\frac{272763}{5562316}}=260012.6\approx260013$

Because the sample size is less than 10% of the original population, we may ignore the fpc adjustment performed in step 2, leaving us with a sample size of 272763.

```{r}
####Compute the sample size for a SRS
##step 1
stdev = sd(pop.data$tripduration)
MOE   = 15 #seconds
N = nrow(pop.data)
print(stdev)
n0srs = ceiling((1.96^2*stdev^2)/(MOE^2))

nsrs = ceiling(n0srs/(1+(n0srs/N)))

print(paste0('With a sample size only ',round(n0srs/N*100,4), '% of the original population, we ignore fpc.'))

print(paste0('Sample Size needed for an estimate of the mean trip duration within 15 seconds, with 95% confidence, is ' , n0srs,'.'))


```

Compute Estimate using survey library with SRS and survey design of SRS 
```{r}
set.seed(n0srs)

pop.data.SRSSampled = sample_n(pop.data,n0srs)
nrow(pop.data.SRSSampled)

boxplot(tripduration ~ DayOfWeek, data = pop.data.SRSSampled, ylab = "tripduration", xlab = "DayOfWeek")

mydesign <- svydesign(id = ~1, data = pop.data.SRSSampled)

svymean(~tripduration, design = mydesign)

```

Compute Estimate using survey library with n0srs, but use surveyDesign of Stratified Sample


```{r}

  # Identify Frequency of DayOfWeek Stratum
PropFreq <- as.data.frame(table(pop.data$DayOfWeek))
names(PropFreq)[1] = 'DayOfWeek'
PropFreq

PropFreq$N = nrow(pop.data)
PropFreq$p = PropFreq$Freq/PropFreq$N
PropFreq$SampSizeh = PropFreq$p * n0srs
PropFreq$SampSizehRounded = round(PropFreq$SampSizeh)
print(PropFreq)

pop.data.PropSampled<-rbind(
                             sample_n(pop.data[pop.data$DayOfWeek == "Monday",],39560)
                            ,sample_n(pop.data[pop.data$DayOfWeek == "Tuesday",],41190)
                            ,sample_n(pop.data[pop.data$DayOfWeek == "Wednesday",],42047)
                            ,sample_n(pop.data[pop.data$DayOfWeek == "Thursday",],40240)
                            ,sample_n(pop.data[pop.data$DayOfWeek == "Friday",],40653)
                            ,sample_n(pop.data[pop.data$DayOfWeek == "Saturday",],35996)
                            ,sample_n(pop.data[pop.data$DayOfWeek == "Sunday",],33077)
)


nrow(pop.data.PropSampled)

boxplot(tripduration ~ DayOfWeek, data = pop.data.PropSampled, ylab = "tripduration", xlab = "DayOfWeek")

mydesign <- svydesign(id = ~1, strata = ~DayOfWeek, data = pop.data.PropSampled)

svymean(~tripduration, design = mydesign)

```

Compute the Design Effect (SE stratified design / SE SRS Design)
```{r}


```

Compute Sample Size for Stratified Design Effect Modification (see 5.6 slides)
```{r}


```


Compute Proportional Allocation sample sizes amongst stratum
```{r}

sampleSize = 250000

pop.data.TOD <- pop.data[c("tripduration", "DayOfWeek")]
head(pop.data.TOD)

  # Identify Frequency of DayOfWeek Stratum
ToDFreq <- as.data.frame(table(pop.data.TOD$DayOfWeek))
names(ToDFreq)[1] = 'DayOfWeek'
ToDFreq


ToDFreq$N = nrow(pop.data.TOD)
ToDFreq$p = ToDFreq$Freq/ToDFreq$N
ToDFreq$SampSizeh = ToDFreq$p * sampleSize
ToDFreq$SampSizehRounded = round(ToDFreq$SampSizeh)

print(sum(ToDFreq$SampSizeh))

ToDFreq



```

Utilize Sample Sizes to compute an Estimate of the mean, using Stratified Design with appropriate sample size
```{r}
  
pop.data.TOD <- pop.data[c("tripduration", "DayOfWeek")]
pop.data.TOD

pop.data.TOD$N <- NA

  # Identify Frequency of DayOfWeek Stratum
ToDFreq <- as.data.frame(table(pop.data.TOD$DayOfWeek))
names(ToDFreq)[1] = 'DayOfWeek'
ToDFreq

#pop.data.TOD$Nh[pop.data.TOD$DayOfWeek == "Friday"] <- 829007
#pop.data.TOD$Nh[pop.data.TOD$DayOfWeek == "Monday"] <- 806725
#pop.data.TOD$Nh[pop.data.TOD$DayOfWeek == "Saturday"] <- 734053
#pop.data.TOD$Nh[pop.data.TOD$DayOfWeek == "Sunday"] <- 674524
#pop.data.TOD$Nh[pop.data.TOD$DayOfWeek == "Thursday"] <- 820587
#pop.data.TOD$Nh[pop.data.TOD$DayOfWeek == "Tuesday"] <- 839970
#pop.data.TOD$Nh[pop.data.TOD$DayOfWeek == "Wednesday"] <- 857450

print(nrow(pop.data.TOD))

pop.data.TOD$N[pop.data.TOD$DayOfWeek == "Friday"] <- 829007
pop.data.TOD$N[pop.data.TOD$DayOfWeek == "Monday"] <- 806725
pop.data.TOD$N[pop.data.TOD$DayOfWeek == "Saturday"] <- 734053
pop.data.TOD$N[pop.data.TOD$DayOfWeek == "Sunday"] <- 674524
pop.data.TOD$N[pop.data.TOD$DayOfWeek == "Thursday"] <- 820587
pop.data.TOD$N[pop.data.TOD$DayOfWeek == "Tuesday"] <- 839970
pop.data.TOD$N[pop.data.TOD$DayOfWeek == "Wednesday"] <- 857450

tail(pop.data.TOD)

  # Create SurveyDesign
mydesign <- svydesign(id = ~1, strata = ~DayOfWeek, data = pop.data.TOD, fpc = ~N)

#mydesign <- postStratify(design = mydesign, strata = ~DayOfWeek, population = ToDFreq)

svymean(~tripduration, design = mydesign)
```


#### Cluster Sampling Design
First, perform SRS to obtain sample clusters.
```{r}
set.seed(100)

pop.data$fpc <- nrow(pop.data)
stations <- as.character(sample(unique(pop.data$start_station_name),10))
stations
```
<br>
Next, create complex design object for one-stage cluster sampling.
```{r}
clus1 <- subset(pop.data, start_station_name %in% stations)
clus1$fpc <- 330

clus1.design <- svydesign(id = ~start_station_name, data = clus1, fpc = ~fpc)
summary(clus1.design)
```
<br>
Begin tripduration mean estimation *(still need to account for weights, etc.)*
```{r}
svymean(~tripduration, design = clus1.design)
```

