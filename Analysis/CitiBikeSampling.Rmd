---
title: "MSDS 6370 Sampling Design"
output:
  html_notebook: default
---

### Load the data

Load necessary libraries

```{r}
require(survey)
require(dplyr)
require(lattice)
```

Pulling in data only if RDS file has not already been created.

```{r}
setwd("../Analysis/Data")
if(!file.exists("popData.rds")){
    pop.data <- NULL
    for(i in 1:length(list.files())){
        data.frag <- read.csv(paste("dataset",i,".csv",sep = ""), header = FALSE)
        pop.data <- rbind(pop.data, data.frag)
    }
    colnames(pop.data) <- c("tripduration",
                            "starttime",
                            "stoptime",
                            "start_station_id",
                            "start_station_name",
                            "start_station_latitude",
                            "start_station_longitude",
                            "end_station_id",
                            "end_station_name",
                            "end_station_latitude",
                            "end_station_longitude",
                            "bikeid",
                            "usertype",
                            "birth year",
                            "gender",
                            "LinearDistance",
                            "DayOfWeek",
                            "TimeOfDay",
                            "HolidayFlag",
                            "PRCP",
                            "SNOW",
                            "TAVE",
                            "TMAX",
                            "TMIN")
    saveRDS(pop.data, "popData.rds")
    rm(data.frag)
} else pop.data <- readRDS("popData.rds")
```

```{r}

    # BoxPlot tripDuration - Heavy Outliers!
boxplot(pop.data$tripduration)
    
    # How Many Greater than 24 hours?
print(nrow(pop.data[pop.data$tripduration>86400,]))

    # Remove > 24 Hours
pop.data <- pop.data[pop.data$tripduration<86400,c("tripduration", "DayOfWeek", "TimeOfDay")]

boxplot(pop.data$tripduration)

bwplot(tripduration ~ DayOfWeek, data = pop.data)
bwplot(tripduration ~ TimeOfDay | DayOfWeek, data = pop.data, scales=list(x=list(rot=45)))

print(paste0("The true mean of the population less outliers is: ", mean(pop.data$tripduration)))

```

### Task 1
#### Stratified Sampling (Proportional Allocation)

First, we estimate the number of samples needed for a simple random sample(SRS) design. Although our goal is to perform a stratified sample for our estimate, we first need to compute a SRS design estimate to assist in calculation of design effect for the stratified design.

$n_{0,srs}=\frac{(Z_{\alpha/2}S)^2}{(moe)^2}=\frac{1.96^2 \times 1400.1478^2}{(15)^2}=33471.6752\approx33472$


Because the sample size is less than 10% of the original population, we may ignore the fpc adjustment performed in step 2, leaving us with a sample size of 33472.

```{r}
####Compute the sample size for a SRS
##step 1
stdev = sd(pop.data$tripduration)
MOE   = 15 #seconds
N = nrow(pop.data)
print(stdev)
n0srs = ceiling((1.96^2*stdev^2)/(MOE^2))

print(paste0('With a sample size only ',round(n0srs/N*100,4), '% of the original population, we ignore fpc.'))

print(paste0('Sample Size needed for an estimate of the mean trip duration within 15 seconds, with 95% confidence, is ' , n0srs, '.'))


```

Compute Estimate using survey library with SRS and survey design of SRS 
```{r}
set.seed(n0srs)

pop.data.SRSSampled = sample_n(pop.data,n0srs)
nrow(pop.data.SRSSampled)

bwplot(tripduration ~ DayOfWeek, data = pop.data.SRSSampled)
bwplot(tripduration ~ TimeOfDay | DayOfWeek, data = pop.data.SRSSampled, scales=list(x=list(rot=45)))

mydesign <- svydesign(id = ~1, data = pop.data.SRSSampled)

srsMean = svymean(~tripduration, design = mydesign)
srsMean

rm(pop.data.SRSSampled)
rm(mydesign)
```

Compute Estimate using survey library with n0srs, but use surveyDesign of Stratified Sample


```{r}

set.seed(n0srs)

  # Identify Frequency of DayOfWeek Stratum
PropFreq <- as.data.frame(table(pop.data[,c("DayOfWeek", "TimeOfDay")]))
names(PropFreq)[1] = 'DayOfWeek'
PropFreq

PropFreq$N = nrow(pop.data)
PropFreq$p = PropFreq$Freq/PropFreq$N
PropFreq$SampSizeh = PropFreq$p * n0srs
PropFreq$SampSizehRounded = round(PropFreq$SampSizeh)
print(head(PropFreq))

pop.data.PropSampled <- NULL

for (i in 1:nrow(PropFreq)){
  pop.data.PropSampled<-rbind(pop.data.PropSampled,
                            sample_n(pop.data[(pop.data$DayOfWeek == PropFreq[i,"DayOfWeek"] 
                                                  & pop.data$TimeOfDay ==   PropFreq[i,"TimeOfDay"])
                                              ,]
                                     ,PropFreq[i,"SampSizehRounded"]
                                     )
                            )
                                
}

print(head(pop.data.PropSampled))

nrow(pop.data.PropSampled)

bwplot(tripduration ~ DayOfWeek, data = pop.data.PropSampled)
bwplot(tripduration ~ TimeOfDay | DayOfWeek, data = pop.data.PropSampled, scales=list(x=list(rot=45)))

mydesign <- svydesign(id = ~1, strata = ~DayOfWeek, data = pop.data.PropSampled)

propMean = svymean(~tripduration, design = mydesign)
propMean

rm(pop.data.PropSampled)
rm(mydesign)

```

Compute the Design Effect (SE stratified design / SE SRS Design)

$deff_{complex}=\frac{V(\bar{y}_{complex})}{V( \bar{y} {srs)})}=\frac{7.3612}{8.2137}=0.8962$

```{r}

deffProp = as.numeric(SE(propMean)/SE(srsMean))
deffProp

```

Compute appropriate Sample Size for Stratified Design Effect Modification (see 5.6 slides)
$n_{0,complex} = n_{0,srs} \times deff_{complex}= 33474 \times 0.8962102 = 29997.95 \approx 29998$

```{r}
n0prop = n0srs*deffProp
n0prop
n0prop = ceiling(n0prop)
n0prop

```


Compute Proportional Allocation sample sizes amongst stratum
Utilize Sample Sizes to compute an Estimate of the mean, using Stratified Design with appropriate sample size

```{r}
set.seed(n0srs)

 # Identify Frequency of DayOfWeek Stratum
PropFreq <- as.data.frame(table(pop.data[,c("DayOfWeek", "TimeOfDay")]))
names(PropFreq)[1] = 'DayOfWeek'
PropFreq

PropFreq$N = nrow(pop.data)
PropFreq$p = PropFreq$Freq/PropFreq$N
PropFreq$SampSizeh = PropFreq$p * n0prop
PropFreq$SampSizehRounded = round(PropFreq$SampSizeh)
print(PropFreq)

pop.data.PropSampled <- NULL

for (i in 1:nrow(PropFreq)){
  pop.data.PropSampled<-rbind(pop.data.PropSampled,
                            sample_n(pop.data[(pop.data$DayOfWeek == PropFreq[i,"DayOfWeek"] 
                                                  & pop.data$TimeOfDay ==   PropFreq[i,"TimeOfDay"])
                                              ,]
                                     ,PropFreq[i,"SampSizehRounded"]
                                     )
                            )
                                
}

nrow(pop.data.PropSampled)

bwplot(tripduration ~ DayOfWeek, data = pop.data.PropSampled)
bwplot(tripduration ~ TimeOfDay | DayOfWeek, data = pop.data.PropSampled, scales=list(x=list(rot=45)))

mydesign <- svydesign(id = ~1, strata = ~DayOfWeek, data = pop.data.PropSampled)

propMean = svymean(~tripduration, design = mydesign)
propMean

propCI = confint(propMean)
propCI


rm(pop.data.PropSampled)
rm(mydesign)
```




#### Neyman Sampling Design

```{r}
  # Identify Frequency of DayOfWeek Stratum
ToDFreq <- as.data.frame(table(pop.data$DayOfWeek))
names(ToDFreq)[1] = 'DayOfWeek'

stdDevs <- tapply(pop.data$tripduration, pop.data$DayOfWeek, sd)
NhSh <- ToDFreq$Freq * stdDevs
NhSh.ratio <- NhSh/sum(NhSh)
sampsRaw <- round(n0srs)*NhSh.ratio
Neyman.samples <- round(sampsRaw)

#cbind(ToDFreq, stdDevs = as.data.frame(as.vector(stdDevs)), as.data.frame(NhSh), as.data.frame(NhSh.ratio), as.data.frame(sampsRaw), as.data.frame(Neyman.samples))
data.frame(ToDFreq,
           stdDevs = as.vector(stdDevs),
           NhSh = as.vector(NhSh),
           NhSh.ratio = as.vector(NhSh.ratio),
           sampsRaw = as.vector(sampsRaw),
           Neyman.samples = as.vector(Neyman.samples))
```
<br>
By rounding the calculated strata sample counts in our table output above, we now have definitive Neyman sample sizes for each stratum. To help validate these numbers' derivation, we choose to calculate their sum - their sum should calculate to our n<sub>0,srs</sub> value.
```{r}
sum(Neyman.samples)
```
<br>
As observed above, our sum is just one sample short of our n<sub>0,srs</sub> value. This is due to rounding error when deriving our whole number sample sizes from our raw, calculated sample sizes. For this reason, we choose to select the largest raw sample size which contains a decimal value less than 0.5 and force it to round up. In this case, Saturday's value of 29459.48 fits this criterion. Therefore, we manually assign a value of 29460 to replace its rounded value of 29460.
```{r}
Neyman.samples[Neyman.samples %in% 29459] <- 29460
sum(Neyman.samples)
```

```{r}
pop.data.Neyman <- data.frame(DayOfWeek = pop.data$DayOfWeek, tripduration = pop.data$tripduration)
pop.data.Neyman$N <- NA

for(i in seq(1,7)) pop.data.Neyman$N[pop.data.Neyman$DayOfWeek == attributes(Neyman.samples[i])] <- Neyman.samples[i]

head(pop.data.Neyman)
tail(pop.data.Neyman)
```
```{r}
prop.samp <- function(i) {
    sample_n(pop.data.Neyman[pop.data.Neyman$DayOfWeek == attributes(Neyman.samples[i]),], Neyman.samples[i])
}

Friday.samples <- prop.samp(1)
Monday.samples <- prop.samp(2)
Saturday.samples <- prop.samp(3)
Sunday.samples <- prop.samp(4)
Thursday.samples <- prop.samp(5)
Tuesday.samples <- prop.samp(6)
Wednesday.samples <- prop.samp(7)

NeySamp <- rbind(Sunday.samples,
                 Monday.samples,
                 Tuesday.samples,
                 Wednesday.samples,
                 Thursday.samples,
                 Friday.samples,
                 Saturday.samples)
```

```{r}
NeySamp <- merge(NeySamp, ToDFreq, by = "DayOfWeek")
```


```{r}
  # Create SurveyDesign
mydesign <- svydesign(id = ~1, strata = ~DayOfWeek, data = NeySamp) # Dropped since no correction needed: , fpc = ~Freq)

#mydesign <- postStratify(design = mydesign, strata = ~DayOfWeek, population = ToDFreq)

svymean(~tripduration, design = mydesign)
```

```{r}
confint(svymean(~tripduration, design = mydesign))
```


